# MedicalRAG: åŸºäºRAGæŠ€æœ¯çš„åŒ»å­¦çŸ¥è¯†é—®ç­”ç³»ç»Ÿæ„å»ºä¸å®‰å…¨æ€§åˆ†æ
> é’ˆå¯¹åŒ»å­¦é¢†åŸŸå¤§æ¨¡å‹â€œå¹»è§‰â€é—®é¢˜ï¼Œæ„å»ºåŒ…å«æ£€ç´¢ã€ä¼˜åŒ–ã€ç”Ÿæˆå…¨æµç¨‹çš„ RAG ç³»ç»Ÿã€‚

## ğŸ“– é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®æ˜¯SDUCSã€Šäººå·¥æ™ºèƒ½ã€‹è¯¾ç¨‹æœŸæœ«å¤§ä½œä¸šçš„å®ç°ä»£ç ã€‚åŸºäº **FlashRAG** æ¡†æ¶è¿›è¡Œæ·±åº¦å®šåˆ¶ï¼Œæ—¨åœ¨è§£å†³ä¸­æ–‡åŒ»å­¦åœºæ™¯ä¸‹çš„æ¨¡å‹å¹»è§‰é—®é¢˜ã€‚ç³»ç»Ÿé›†æˆäº†ç¨ å¯†æ£€ç´¢ã€æ··åˆæç¤ºç­–ç•¥ï¼ˆHybrid Promptï¼‰ä»¥åŠè‡ªåŠ¨åŒ–å®‰å…¨æ€§è¯„ä¼°æ¨¡å—ã€‚

### ğŸŒŸ æ ¸å¿ƒç‰¹æ€§

* **ğŸ” å¼ºåŠ›æ£€ç´¢å™¨ (Retriever)**
    * é›†æˆ [**BAAI/bge-large-zh-v1.5**](https://huggingface.co/BAAI/bge-large-zh-v1.5) æ¨¡å‹ï¼Œæ„å»ºé«˜ç»´ç¨ å¯†å‘é‡ç´¢å¼•ï¼Œç²¾å‡†æ•æ‰ä¸­æ–‡åŒ»å­¦è¯­ä¹‰ã€‚
    * æ”¯æŒ FAISS é«˜æ•ˆæ£€ç´¢ã€‚

* **ğŸ“š æƒå¨æ•°æ®æº (Corpus)**
    * ä½¿ç”¨ [**Huatuo-26M-Lite**](https://huggingface.co/datasets/FreedomIntelligence/Huatuo26M-Lite) æ•°æ®é›†ï¼Œæä¾›çœŸå®çš„åŒ»ç”Ÿé—®ç­”çŸ¥è¯†åº“ï¼Œç¡®ä¿æ£€ç´¢å†…å®¹çš„ä¸“ä¸šæ€§ã€‚

* **ğŸ§  æ··åˆç”Ÿæˆç­–ç•¥ (Hybrid Strategy)**
    * å®ç°äº† **Baseline / Strict / Hybrid** ä¸‰ç§å¯¹æ¯”å®éªŒæ¨¡å¼ã€‚
    * **Hybrid Prompt**: é‡‡ç”¨â€œæ£€ç´¢ä¼˜å…ˆ + çŸ¥è¯†é™çº§â€ç­–ç•¥ï¼Œåœ¨å‚è€ƒæ£€ç´¢å†…å®¹çš„åŒæ—¶ï¼Œå…è®¸æ¨¡å‹åˆ©ç”¨è‡ªèº«çŸ¥è¯†è¡¥å……ï¼Œå¹³è¡¡å‡†ç¡®æ€§ä¸å¯ç”¨æ€§ã€‚

* **ğŸ›¡ï¸ å®‰å…¨ä¸è¯„ä¼° (Safety & Eval)**
    * å†…ç½®è‡ªåŠ¨åŒ–è¯„ä¼°æµæ°´çº¿ï¼Œæ”¯æŒ `gpt_harmful_rate` (æœ‰å®³ç‡) å’Œ `gpt_hallucination_rate` (å¹»è§‰ç‡) ç­‰æŒ‡æ ‡ã€‚
    * æ”¯æŒ **vLLM** æœ¬åœ°éƒ¨ç½²æ¨ç†åŠ é€Ÿä¸ OpenAI æ ¼å¼ API (å¦‚ DeepSeek, GPT-4o) è°ƒç”¨ã€‚

## ğŸ“‚ ç›®å½•ç»“æ„

```text
MedicalRAG/
â”œâ”€â”€ FlashRAG/               # æ ¸å¿ƒæ¡†æ¶æºç  (æœ¬åœ°ä¿®æ”¹ç‰ˆï¼ŒåŒ…å«å®šåˆ¶çš„ Pipeline)
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ build_bge_index.sh  # BGE å‘é‡ç´¢å¼•æ„å»ºè„šæœ¬
â”‚   â”œâ”€â”€ process_data.py     # æ•°æ®é¢„å¤„ç†ä¸ä¸‹è½½è„šæœ¬
â”‚   â””â”€â”€ ...
â”œâ”€â”€ indexes/                # å­˜æ”¾æ„å»ºå¥½çš„ FAISS ç´¢å¼• (è¿è¡Œè„šæœ¬åç”Ÿæˆ)
â”œâ”€â”€ main.py                 # å®éªŒä¸»ç¨‹åº (åŒ…å« Prompt å®šä¹‰ä¸å®éªŒé€»è¾‘)
â”œâ”€â”€ host_run.sh             # vLLM éƒ¨ç½²ä¸å®éªŒä¸€é”®è¿è¡Œè„šæœ¬
â”œâ”€â”€ my_config.yaml          # FlashRAG æ ¸å¿ƒé…ç½®æ–‡ä»¶ (æ¨¡å‹è·¯å¾„ã€å‚æ•°ç­‰)
â”œâ”€â”€ requirements.txt        # é¡¹ç›®ä¾èµ–åˆ—è¡¨
â””â”€â”€ README.md               # é¡¹ç›®è¯´æ˜æ–‡æ¡£

```

## ğŸ› ï¸ ç¯å¢ƒå®‰è£…

1. **åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ** (å»ºè®® Python 3.10+)ï¼š
```bash
conda create -n medical_rag python=3.10
conda activate medical_rag

```


2. **å®‰è£…ä¾èµ–**ï¼š
```bash
pip install -r requirements.txt

```


> **æ³¨æ„**ï¼šæœ¬é¡¹ç›®ç›´æ¥å¼•ç”¨æœ¬åœ°çš„ `FlashRAG/` ç›®å½•ï¼Œæ— éœ€ pip å®‰è£… flashrag åŒ…ï¼Œä»¥ç¡®ä¿èƒ½ä½¿ç”¨å®šåˆ¶ä¿®æ”¹çš„åŠŸèƒ½ã€‚



## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¬¬ä¸€æ­¥ï¼šæ•°æ®å‡†å¤‡

ä¸‹è½½å¹¶é¢„å¤„ç† Huatuo æ•°æ®é›†ï¼š

```bash
python utils/process_data.py

```

*ç¡®ä¿æ•°æ®å·²æ­£ç¡®æ”¾ç½®åœ¨ `data/` ç›®å½•ä¸‹ã€‚*

### ç¬¬äºŒæ­¥ï¼šæ„å»ºå‘é‡ç´¢å¼•

ä½¿ç”¨ BGE æ¨¡å‹å¯¹è¯­æ–™åº“è¿›è¡Œç¼–ç å¹¶æ„å»º FAISS ç´¢å¼•ï¼š

```bash
bash utils/build_bge_index.sh

```

*è„šæœ¬ä¼šè‡ªåŠ¨åŠ è½½æ¨¡å‹ã€åˆ‡åˆ†è¯­æ–™ï¼Œå¹¶å°†ç´¢å¼•æ–‡ä»¶ä¿å­˜è‡³ `indexes/` ç›®å½•ã€‚*

### ç¬¬ä¸‰æ­¥ï¼šé…ç½®ä¸è¿è¡Œ
>è¯·å…ˆåœ¨`my_config.yaml`ä¸­é…ç½®`api_url`å’Œ`api_key`

#### æ–¹å¼ Aï¼šä¸€é”®è¿è¡Œ (æ¨è)

ä½¿ç”¨ `host_run.sh` è„šæœ¬ï¼Œå®ƒä¼šè‡ªåŠ¨å¯åŠ¨ vLLM æœåŠ¡å¹¶ä¾æ¬¡è¿è¡Œæ‰€æœ‰å®éªŒç­–ç•¥ï¼š

```bash
bash host_run.sh

```

> **æç¤º**ï¼šè¯·å…ˆåœ¨ `host_run.sh` ä¸­é…ç½® `MODEL_PATH` å’Œ `GPU_IDS`ã€‚

#### æ–¹å¼ Bï¼šæ‰‹åŠ¨è¿è¡Œ

å¦‚æœæ‚¨ä½¿ç”¨ API æ¨¡å¼æˆ–å·²æ‰‹åŠ¨å¯åŠ¨æœåŠ¡ï¼Œå¯ä»¥ç›´æ¥è¿è¡Œ `main.py`ï¼š

```bash
# è¿è¡Œ Baseline (æ— æ£€ç´¢)
python main.py --strategy baseline --split test --gpu_id 0

# è¿è¡Œ Hybrid RAG (æ··åˆç­–ç•¥)
python main.py --strategy hybrid --split test --gpu_id 0

```

## ğŸ“Š å®éªŒä¸é…ç½®è¯´æ˜

### 1. å®éªŒæ¨¡å¼ (Strategy)

åœ¨ `main.py` ä¸­å®šä¹‰äº†ä»¥ä¸‹å‡ ç§å®éªŒç­–ç•¥ï¼š

* **`baseline`**: ä»…åˆ©ç”¨å¤§æ¨¡å‹è‡ªèº«çŸ¥è¯†å›ç­” (Zero-shot)ã€‚
* **`strict`**: ä¸¥æ ¼é™åˆ¶æ¨¡å‹ä»…ä¾æ®æ£€ç´¢åˆ°çš„å‚è€ƒèµ„æ–™å›ç­” (Strict RAG)ã€‚
* **`hybrid`**: ç»“åˆæ£€ç´¢å†…å®¹ä¸æ¨¡å‹çŸ¥è¯† (Ours)ï¼Œæ—¨åœ¨å‡å°‘æ‹’ç­”ç‡å¹¶ä¿æŒå‡†ç¡®æ€§ã€‚

### 2. å…³é”®å‚æ•°é…ç½®

é¡¹ç›®é…ç½®ä¸»è¦ä½äº `my_config.yaml` å’Œ `main.py` ä¸­ã€‚

* **`main.py`**:
    * `api_setting`: é…ç½®ç”Ÿæˆå™¨æ¨¡å‹ (å¦‚ `deepseek-r1`, `gpt-4o-mini`) å’Œå¹¶å‘æ•°ã€‚
    * `retrieval_topk`: æ£€ç´¢å¬å›æ•°é‡ (é»˜è®¤ä¸º 5)ã€‚


* **`my_config.yaml`**:
    * `model2path`: å®šä¹‰å„ç±»æ¨¡å‹ (Retrieval/Generator) çš„æœ¬åœ°è·¯å¾„ã€‚
    * `index_path`: æŒ‡å®š FAISS ç´¢å¼•æ–‡ä»¶çš„è·¯å¾„ã€‚
    * `generation_params`: è®¾ç½® `temperature` (å»ºè®®è®¾ä¸º 0.1 ä»¥ä¿æŒåŒ»å­¦å›ç­”ä¸¥è°¨æ€§)ã€‚



## ğŸ“ è‡´è°¢

æœ¬é¡¹ç›®å‚è€ƒå¹¶æ„Ÿè°¢ä»¥ä¸‹å¼€æºå·¥ä½œï¼š

* [FlashRAG](https://github.com/RUC-NLPIR/FlashRAG) - æä¾›äº†å¼ºå¤§çš„ RAG æ¨¡å—åŒ–æ¡†æ¶ã€‚
* [Huatuo-26M](https://github.com/FreedomIntelligence/Huatuo-26M) - æä¾›äº†é«˜è´¨é‡çš„åŒ»å­¦é—®ç­”æ•°æ®é›†ã€‚
* [BGE Embeddings](https://github.com/FlagOpen/FlagEmbedding) - æä¾›äº†ä¼˜ç§€çš„ä¸­æ–‡è¯­ä¹‰å‘é‡æ¨¡å‹ã€‚

